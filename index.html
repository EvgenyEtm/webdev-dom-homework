<!DOCTYPE html>
<html>
  <head>
    <title>Проект "Комменты"</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="styles.css" />
  </head>

  <body>
    <div class="container">
      <h2 style="color: green; font-size: 40px;">Комментарии загружаются...</h2>
      <ul class="comments">
        
      </ul>
      <div class="add-form">
        <input
          type="text"
          class="add-form-name"
          placeholder="Введите ваше имя"
        />
        <textarea
          type="textarea"
          style="white-space:pre-line"
          class="add-form-text"
          placeholder="Введите ваш коментарий"
          rows="4"
        ></textarea>
        <div class="add-form-row">
          <button class="add-form-button">Написать</button>
        </div>
      </div>
    </div>
  </body>
<style>
  .red {
    background-color: red;
  }

  .unactive{
    background-color: #9e9e9e;
  }
  .newNew{
    background-color: green;
  }
</style>
  <script>
    "use strict";
// Код писать здесь
const text = document.querySelector('.add-form-text');
const name = document.querySelector('.add-form-name');
const boxMessages = document.querySelector('.comments');
const button = document.querySelector('.add-form-button');
const del = document.querySelectorAll('ul > li');
const downloadAlert = document.querySelector('h2')
const date = new Date();
button.disabled = true;
button.classList.add('unactive');
// const UlComments = document.getElementById('comments')
// console.log(UlComments);
console.log(downloadAlert);

//console.log(boxMessages);

text.addEventListener("input", () => {
  button.disabled = false;
  button.classList.remove('unactive');
}); 
name.addEventListener("input", () => {
  button.disabled = false;
  button.classList.remove('unactive');
}); 



text.addEventListener("keyup", keyCode);

function keyCode(e) {
if (e.keyCode === 13) {
    addCommentare();
} else {
  return;
}
}
function formatDate(date) {




// let dd = date.getDate();
// if (dd < 10) dd = '0' + dd;

// let mm = date.getMonth() + 1;
// if (mm < 10) mm = '0' + mm;

// let yy = date.getFullYear() % 100;
// if (yy < 10) yy = '0' + yy;

// let hh = date.getHours();
// if (hh < 10) hh = '0' + hh;

// let min = date.getMinutes();
// if (min < 10) min = '0' + min;

// return dd + '.' + mm + '.' + yy + ' ' + hh + ':' + min;
}


let comments = [];
const apiCommentsGet = () => {
  return fetch('https://wedev-api.sky.pro/api/v1/:Evgeny-Onotskiy/comments', {
  method: 'GET'
})
.then((response) => response.json())
.then((response) => {
  comments.textContent = 'Комментарии загружаются...';
  return response; 
})
.then((responseData) => {
  const apiComments = responseData.comments.map((comment) =>{
    return {
      name: comment.author.name,
      date: ((new Date(comment.date)).getDate() + "." + 0 + (Number((new Date(comment.date)).getMonth()) + 1) + "." + (Number((new Date(comment.date)).getFullYear()) - 2000) + " " + (new Date(comment.date)).getHours() + ":" + (new Date(comment.date)).getMinutes()),
      text: comment.text,
      like: comment.likes,
      isLiked: false,
      isEdit: false,
    }
});
comments = apiComments;
renderFunction();
}).then(() => {
  downloadAlert.style = 'display: none';
})

// fetchPromise.then((response) => {

//   response.json().then((responseData) => {
// const apiComments = responseData.comments.map((comment) =>{



//   return {
//       name: comment.author.name,
//       date: new Date(comment.date),
//       text: comment.text,
//       like: comment.likes,
//       isLiked: false,
//       isEdit: false,
//     }
// });

// comments = apiComments;
// renderFunction();
//     // console.log(responseData);
//     // //comments = responseData.comments;
//   });
// });
}
apiCommentsGet();

const likedFunction = () => {
  const likeButtons = document.querySelectorAll('.like-button');
  // console.log(likeButtons);
  for (const likeButton of likeButtons) {
    likeButton.addEventListener('click', () => {
      const index = likeButton.dataset.index
      //console.log();
      if (comments[index].isLiked === true) {
        comments[index].like--;
        comments[index].isLiked = false;
      } else if(comments[index].isLiked === false) {
        comments[index].like++;
        comments[index].isLiked = true;
      }
      renderFunction();
    })
    
  }
}
// const editText = () => {
//   const newTexts = document.querySelectorAll('.edit-text');
//   for (const newText of newTexts) {
//     const index = newText.dataset.index;
//     console.log(newText.value);
//   }

// }

const editButton = () => {

  const editButtons = document.querySelectorAll('.edit-button');

  for (const editButton of editButtons) {
editButton.addEventListener('click', (event) => {
  event.stopPropagation();
  const index = editButton.dataset.index; 
  //console.log(comments[edit].isEdit);
    if (comments[index].isEdit === true) {
      const newTexts = document.querySelectorAll('.edit-text');
      for (const newText of newTexts) {
       comments[index].text = newText.value;
       comments[index].isEdit = false;
        }
    } else if (comments[index].isEdit === false) {
      comments[index].isEdit = true;
      //console.log(comments[index].isEdit);
    }
    renderFunction();


})
  }
}

// const colorClass = () => {
//   const bgcWhite = document.querySelectorAll('.quote');
//   for (const bgcWhit of bgcWhite) {
//     //console.log(bgcWhit);
//   }
// }
const answerElement = () => {
  const answerTexts = document.querySelectorAll('.comment-text');
  //console.log(answerTexts);
  for( const answerText of answerTexts)
  answerText.addEventListener('click', (event) => {
    event.stopPropagation();
    const index = answerText.dataset.index; 
      //console.log(answerText.dataset.index);
      text.value = `BEGIN_QUOTE > ${comments[index].name} \n  ${comments[index].text} QUOTE_END \n`;

      renderFunction();

  })
}

const renderFunction = () => {
  const commtentsHtml = comments
  .map((comment, index, edit) => {
    return `<li class="comment">
          <div class="comment-header">
            <div>${comment.name}</div>
            <div>${comment.date}</div>
          </div>
          <div class='quote'>
            <div class="comment-body">
            ${comment.isEdit? `<textarea data-index="${index}" class="edit-text white-space: pre-line">${comment.text}</textarea>` : `<div data-index="${index}" class="comment-text" style="white-space:pre-line">${comment.text
              .replaceAll("BEGIN_QUOTE", "<div class='quoteOne'>")
              .replaceAll("QUOTE_END", "</div>")}</div>`}
          </div>
            </div>
          <div class="comment-footer">
            <div class="likes">
              <span class="likes-counter">${comment.like}</span>
              <button data-index="${index}" class="${comment.isLiked ? 'like-button -active-like' : 'like-button'}"></button>
            </div>
            
          </div>
          <button data-index="${index}" class="edit-button">${comment.isEdit? 'Сохранить' : 'Редактировать'}</button>
        </li>`
  }

  ).join("");
  boxMessages.innerHTML = commtentsHtml;
  likedFunction();
  editButton();
  answerElement();
  //colorClass();
};
renderFunction();









 let n = 0;


button.addEventListener("click", () => {
  addCommentare();

});


function addCommentare() {
      let savedTextValue = text.value;
      let savedNameValue = name.value;
      // console.log(savedTextValue);
      // console.log(savedNameValue);
  text.classList.remove('red');
  name.classList.remove('red');
  if(name.value === '' && text.value === '') {
    text.placeholder = 'Это поле не должно быть пустым'
    text.classList.add('red');
    name.placeholder = 'Это поле не должно быть пустым'
    name.classList.add('red');
    return;
  }
  else if (name.value === '') {
    name.placeholder = 'Это поле не должно быть пустым'
    name.classList.add('red');
    return;
  } else if (text.value === ''){
    text.placeholder = 'Это поле не должно быть пустым'
    text.classList.add('red');
    return;
  }
  button.textContent = 'Загрузка.'
  button.disabled = true;
  button.classList.add('unactive');

function postComment () {
  fetch('https://wedev-api.sky.pro/api/v1/:Evgeny-Onotskiy/comments', {
    method: 'POST',
    body: JSON.stringify({
      name: name.value,
      text: text.value,
      // date: formatDate(date),
      // like: 0,
      // isLiked: false,
      // isEdit: false,
      forceError: true,
    })
    })
    // .then(() => {

    // })
    .then((response) =>{
      if (response.status === 400){
        throw new Error('некорректный запрос');
      }
      if (response.status === 500 ) {
        throw new Error('ошибка сервера');
      }
      if (response.status === 201) {
        return response.json();
      } 
    })
    .then(() => {
    return apiCommentsGet();
    })

    .then((response) => {
      button.textContent = 'Написать'
      name.value = '';
      text.value = '';
    })
    .catch((error) => {
      console.warn(error);
      if (error.message === 'некорректный запрос') {
        alert('Имя и комментарий должны быть не короче 3 символов');
      }
      if (error.message === 'ошибка сервера') {
        alert('Сломался сервер, попробуйте позже');
        postComment();
      }
      if (window.navigator.onLine === false) {
        alert('Проблемы с интернетом, проверьте подключение.');
      }
      button.disabled = false;
      button.textContent = 'Написать'
      button.classList.remove('unactive');
      button.classList.add('class="add-form-button"')
      name.value = savedNameValue;
      text.value = savedTextValue;
      // alert(error)

    })
};
postComment();

// comments.push({
//     name: name.value
//     .replaceAll("&", "&amp")
//     .replaceAll("<", "&lt")
//     .replaceAll(">", "&gt")
//     .replaceAll('"', "&quot"),
//     text: text.value    
//     .replaceAll("&", "&amp")
//     .replaceAll("<", "&lt")
//     .replaceAll(">", "&gt")
//     .replaceAll('"', "&quot")
//     .replaceAll("BEGIN_QUOTE", "<div class='quoteOne'>")
//     .replaceAll("QUOTE_END", "</div>"),
//     date: formatDate(date),
//     like: 0,
//     isLiked: false,
//     isEdit: false,
// });

  name.value = '';
  text.value = '';

  renderFunction();
  
}




    //console.log("It works!");
  </script>
</html>